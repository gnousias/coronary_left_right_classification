<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>TensorFlow.js Image Classifier</title>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>
  <style>
    body { font-family: Arial; padding: 20px;}
    img { max-width: 300px; margin-top: 10px; display: block; }
    button { padding: 10px 20px; font-size: 16px; margin-top: 10px; }
    #status { font-weight: bold; margin-top: 10px; }
  </style>
</head>
<body>

<h2>Image Classifier</h2>

<input type="file" id="imageUpload" accept="image/*"><br>
<img id="preview" alt="Image preview will appear here.">
<button id="predictBtn" onclick="predict()" disabled>Predict</button>

<p id="status">Loading model...</p>
<p><strong>Prediction:</strong> <span id="predictionResult">None</span></p>

<script>
let model;
const predictBtn = document.getElementById('predictBtn');
const imageElement = document.getElementById('preview');
const predictionResult = document.getElementById('predictionResult');
const status = document.getElementById('status');

// Load model safely
async function loadModel() {
  try {
    model = await tf.loadLayersModel('tfjs_model30/model.json');
    status.innerText = "‚úÖ Model loaded and ready!";
    predictBtn.disabled = false;
  } catch (err) {
    status.innerText = "‚ùå Error loading model.";
    console.error(err);
  }
}

// Handle image upload
document.getElementById('imageUpload').addEventListener('change', (event) => {
  const file = event.target.files[0];
  if (!file) return;

  const reader = new FileReader();
  reader.onload = () => {
    imageElement.src = reader.result;
  };
  reader.readAsDataURL(file);
});

// Predict function with full async safety
async function predict() {
  if (!model) {
    alert("Model not loaded yet.");
    return;
  }

  if (!imageElement.src || !imageElement.complete) {
    alert("Please upload an image first.");
    return;
  }

  status.innerText = "üîÑ Predicting...";
  tf.engine().startScope(); // clean memory

  try {
    const tensor = tf.browser.fromPixels(imageElement)
      .resizeNearestNeighbor([224, 224])
      .toFloat()
      .expandDims();

    const prediction = await model.predict(tensor).data();
    const classIndex = prediction.indexOf(Math.max(...prediction));

    // Adjust class labels if needed
    const labels = ['Left', 'Right'];
    const confidence = (prediction[classIndex] * 100).toFixed(2);

    predictionResult.innerText = `${labels[classIndex]} (${confidence}%)`;
    status.innerText = "‚úÖ Prediction complete.";
  } catch (err) {
    console.error("Prediction error:", err);
    status.innerText = "‚ùå Error during prediction.";
  }

  tf.engine().endScope();
}

// Initialize
loadModel();
</script>

</body>
</html>
